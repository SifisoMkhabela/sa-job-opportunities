<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SA Job Opportunities - Job Listings</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    crossorigin="anonymous"
  />
  <style>
    /* Mobile filter popup styling */
    #mobileFilterPopup {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1050;
      justify-content: center;
      align-items: center;
    }
    #mobileFilterPopup[aria-hidden="false"] {
      display: flex;
    }
    .popup-content {
      background: white;
      padding: 1.5rem;
      border-radius: 0.5rem;
      max-width: 400px;
      width: 90vw;
      max-height: 90vh;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <main class="container my-5">
    <h1 class="mb-4">Job Listings</h1>

    <!-- Desktop Filters -->
    <form id="filter-form" class="row g-3 mb-4" autocomplete="off">
      <div id="desktopFilters" class="d-flex flex-wrap gap-3 align-items-center">
        <input
          type="text"
          id="filter-keyword"
          class="form-control"
          placeholder="Job Title, Skill or Company"
          style="min-width: 200px;"
          aria-label="Job Title, Skill or Company"
        />
        <input
          type="text"
          id="filter-location"
          class="form-control"
          placeholder="Location"
          style="min-width: 150px;"
          aria-label="Location"
        />
        <select id="filter-type" class="form-select" style="min-width: 150px;" aria-label="Job Type">
          <option value="">All Types</option>
          <!-- Dynamic options -->
        </select>
        <select id="filter-category" class="form-select" style="min-width: 150px;" aria-label="Job Category">
          <option value="">All Categories</option>
          <!-- Dynamic options -->
        </select>
        <button type="submit" class="btn btn-primary">Filter</button>
        <button type="button" id="clearFiltersBtn" class="btn btn-secondary">Clear Filters</button>
      </div>

      <!-- Mobile Filter Button -->
      <div class="d-flex d-md-none mt-3">
        <button type="button" id="mobileFilterBtn" class="btn btn-primary w-100" aria-haspopup="dialog" aria-controls="mobileFilterPopup">
          <i class="fa fa-filter me-2"></i> Filter Jobs
        </button>
      </div>
    </form>

    <!-- Mobile Filter Popup -->
    <div id="mobileFilterPopup" aria-hidden="true" role="dialog" aria-modal="true" aria-label="Filter Jobs">
      <div class="popup-content">
        <h5>Filter Jobs</h5>
        <form id="mobileFilterForm" autocomplete="off">
          <div class="mb-3">
            <label for="mobileFilterKeyword" class="form-label">Job Title, Skill or Company</label>
            <input type="text" id="mobileFilterKeyword" class="form-control" placeholder="Keyword" />
          </div>
          <div class="mb-3">
            <label for="mobileFilterLocation" class="form-label">Location</label>
            <input type="text" id="mobileFilterLocation" class="form-control" placeholder="Location" />
          </div>
          <div class="mb-3">
            <label for="mobileFilterType" class="form-label">Job Type</label>
            <select id="mobileFilterType" class="form-select">
              <option value="">All Types</option>
              <!-- Dynamic options -->
            </select>
          </div>
          <div class="mb-3">
            <label for="mobileFilterCategory" class="form-label">Category</label>
            <select id="mobileFilterCategory" class="form-select">
              <option value="">All Categories</option>
              <!-- Dynamic options -->
            </select>
          </div>
          <div class="d-flex justify-content-between">
            <button type="button" id="mobileClearFiltersBtn" class="btn btn-secondary">Clear Filters</button>
            <div>
              <button type="button" id="mobileFilterCancelBtn" class="btn btn-outline-secondary me-2">Cancel</button>
              <button type="submit" class="btn btn-primary">Apply Filter</button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Job Listings -->
    <div id="jobs-list" class="mt-4">
      <div class="text-center text-muted">Loading jobs...</div>
    </div>
  </main>

  <footer class="bg-dark text-white py-4 mt-5 text-center">
    &copy; 2025 SA Job Opportunities. All rights reserved.
  </footer>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // Your Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDTfLfb9gnn4zBGju8XoqAe-i7g9ahJyJk",
      authDomain: "sa-job-opportunities.firebaseapp.com",
      projectId: "sa-job-opportunities",
      storageBucket: "sa-job-opportunities.appspot.com",
      messagingSenderId: "370537417491",
      appId: "1:370537417491:web:520e9dc1efb1d8cf38a8e6",
      measurementId: "G-ZTK2KXSLXD"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const jobsList = document.getElementById('jobs-list');
    const filterForm = document.getElementById('filter-form');
    const keywordInput = document.getElementById('filter-keyword');
    const locationInput = document.getElementById('filter-location');
    const typeSelect = document.getElementById('filter-type');
    const categorySelect = document.getElementById('filter-category');
    const clearFiltersBtn = document.getElementById('clearFiltersBtn');

    const mobileFilterPopup = document.getElementById('mobileFilterPopup');
    const mobileFilterBtn = document.getElementById('mobileFilterBtn');
    const mobileFilterForm = document.getElementById('mobileFilterForm');
    const mobileKeywordInput = document.getElementById('mobileFilterKeyword');
    const mobileLocationInput = document.getElementById('mobileFilterLocation');
    const mobileTypeSelect = document.getElementById('mobileFilterType');
    const mobileCategorySelect = document.getElementById('mobileFilterCategory');
    const mobileFilterCancelBtn = document.getElementById('mobileFilterCancelBtn');
    const mobileClearFiltersBtn = document.getElementById('mobileClearFiltersBtn');

    let allJobs = [];
    let allTypes = new Set();
    let allCategories = new Set();

    function formatDate(date) {
      const y = date.getFullYear();
      const m = ('0' + (date.getMonth() + 1)).slice(-2);
      const d = ('0' + date.getDate()).slice(-2);
      return `${y}-${m}-${d}`;
    }

    function renderJob(job) {
      const deadlineStr = job.deadline ? formatDate(new Date(job.deadline)) : 'N/A';
      const daysLeft = job.daysLeft > 0 ? `${job.daysLeft} days left` : 'Expired';

      const card = document.createElement('div');
      card.className = 'card mb-3 job-card';
      card.innerHTML = `
        <div class="card-body">
          <h5 class="card-title">${job.title}</h5>
          <h6 class="card-subtitle mb-2 text-muted">${job.company}</h6>
          <p class="card-text">
            <strong>Type:</strong> ${job.type || 'N/A'}<br />
            <strong>Category:</strong> ${job.category || 'N/A'}<br />
            <strong>Deadline:</strong> ${deadlineStr} (${daysLeft})
          </p>
          <a href="${job.link}" target="_blank" class="btn btn-primary" rel="noopener noreferrer">Apply / Details</a>
        </div>
      `;
      return card;
    }

    function populateFilterOptions() {
      function clearOptions(select) {
        while (select.options.length > 1) select.remove(1);
      }

      clearOptions(typeSelect);
      clearOptions(categorySelect);
      clearOptions(mobileTypeSelect);
      clearOptions(mobileCategorySelect);

      Array.from(allTypes).sort().forEach(type => {
        const opt1 = new Option(type, type);
        const opt2 = new Option(type, type);
        typeSelect.add(opt1);
        mobileTypeSelect.add(opt2);
      });

      Array.from(allCategories).sort().forEach(cat => {
        const opt1 = new Option(cat, cat);
        const opt2 = new Option(cat, cat);
        categorySelect.add(opt1);
        mobileCategorySelect.add(opt2);
      });
    }

    function filterJobs() {
      const keyword = keywordInput.value.trim().toLowerCase();
      const location = locationInput.value.trim().toLowerCase();
      const selectedType = typeSelect.value;
      const selectedCategory = categorySelect.value;

      return allJobs.filter(job => {
        if (job.isExpired) return false;

        if (keyword) {
          const combined = (job.title + ' ' + job.company).toLowerCase();
          if (!combined.includes(keyword)) return false;
        }

        if (location) {
          if (!job.location || !job.location.toLowerCase().includes(location)) return false;
        }

        if (selectedType && job.type !== selectedType) return false;
        if (selectedCategory && job.category !== selectedCategory) return false;

        return true;
      });
    }

    function renderJobs(jobs) {
      jobsList.innerHTML = '';
      if (jobs.length === 0) {
        jobsList.innerHTML = `<p class="text-center text-muted">No jobs match your filters.</p>`;
        return;
      }
      jobs.forEach(job => {
        jobsList.appendChild(renderJob(job));
      });
    }

    function syncMobileFiltersToDesktop() {
      keywordInput.value = mobileKeywordInput.value;
      locationInput.value = mobileLocationInput.value;
      typeSelect.value = mobileTypeSelect.value;
      categorySelect.value = mobileCategorySelect.value;
    }

    function syncDesktopFiltersToMobile() {
      mobileKeywordInput.value = keywordInput.value;
      mobileLocationInput.value = locationInput.value;
      mobileTypeSelect.value = typeSelect.value;
      mobileCategorySelect.value = categorySelect.value;
    }

    // Load jobs from Firestore
    db.collection('jobs').get()
      .then(snapshot => {
        allJobs = snapshot.docs.map(doc => {
          const data = doc.data();
          const deadline = data.deadline ? new Date(data.deadline) : null;
          const today = new Date();
          const isExpired = deadline ? deadline < today : false;
          const daysLeft = deadline ? Math.ceil((deadline - today) / (1000 * 60 * 60 * 24)) : null;

          // Collect types and categories
          if (data.type) allTypes.add(data.type);
          if (data.category) allCategories.add(data.category);

          return {
            id: doc.id,
            title: data.title || '',
            company: data.company || '',
            type: data.type || '',
            category: data.category || '',
            deadline: deadline,
            daysLeft: daysLeft,
            link: data.link || '#',
            location: data.location || '',
            isExpired: isExpired,
          };
        });

        populateFilterOptions();
        renderJobs(filterJobs());
      })
      .catch(error => {
        jobsList.innerHTML = `<p class="text-danger text-center">Error loading jobs: ${error.message}</p>`;
      });

    // Event handlers

    filterForm.addEventListener('submit', e => {
      e.preventDefault();
      renderJobs(filterJobs());
      syncDesktopFiltersToMobile();
    });

    clearFiltersBtn.addEventListener('click', () => {
      keywordInput.value = '';
      locationInput.value = '';
      typeSelect.value = '';
      categorySelect.value = '';
      renderJobs(filterJobs());
      syncDesktopFiltersToMobile();
    });

    // Mobile filter popup open
    mobileFilterBtn.addEventListener('click', () => {
      syncDesktopFiltersToMobile();
      mobileFilterPopup.setAttribute('aria-hidden', 'false');
      mobileFilterPopup.style.display = 'flex';
      mobileKeywordInput.focus();
    });

    // Mobile filter popup close
    function closeMobilePopup() {
      mobileFilterPopup.setAttribute('aria-hidden', 'true');
      mobileFilterPopup.style.display = 'none';
      mobileFilterBtn.focus();
    }

    mobileFilterCancelBtn.addEventListener('click', e => {
      e.preventDefault();
      closeMobilePopup();
    });

    mobileClearFiltersBtn.addEventListener('click', e => {
      e.preventDefault();
      mobileKeywordInput.value = '';
      mobileLocationInput.value = '';
      mobileTypeSelect.value = '';
      mobileCategorySelect.value = '';
    });

    mobileFilterForm.addEventListener('submit', e => {
      e.preventDefault();
      // Copy mobile filters to desktop filters
      keywordInput.value = mobileKeywordInput.value;
      locationInput.value = mobileLocationInput.value;
      typeSelect.value = mobileTypeSelect.value;
      categorySelect.value = mobileCategorySelect.value;

      renderJobs(filterJobs());
      closeMobilePopup();
    });

    // Close popup on ESC key
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape' && mobileFilterPopup.getAttribute('aria-hidden') === 'false') {
        closeMobilePopup();
      }
    });

  </script>
</body>
</html>


