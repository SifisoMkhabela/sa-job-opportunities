<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SA Job Opportunities</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Font Awesome for filter icon -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />

  <style>
    /* Smaller form controls on desktop filters */
    #filter-form .form-control, #filter-form .form-select {
      max-width: 180px;
    }

    /* Mobile filter popup content */
    #mobileFilterPopup {
      display: none;
      position: fixed;
      top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
      z-index: 1050;
    }
    #mobileFilterPopup .popup-content {
      max-width: 400px;
      width: 90%;
    }
  </style>
</head>
<body>
  <div class="container my-4">
    <h1 class="mb-4 text-center">SA Job Opportunities</h1>

    <!-- Desktop Filters (visible md and up) -->
    <form id="filter-form" class="d-none d-md-flex align-items-center gap-3 flex-wrap justify-content-center mb-3" autocomplete="off" aria-label="Filter jobs form">
      <input type="text" id="filter-keyword" class="form-control" placeholder="Job title, skill, company" aria-label="Keyword" />
      <input type="text" id="filter-location" class="form-control" placeholder="Location" aria-label="Location" />
      <select id="filter-type" class="form-select" aria-label="Job type">
        <option value="">All Types</option>
      </select>
      <select id="filter-category" class="form-select" aria-label="Job category">
        <option value="">All Categories</option>
      </select>
      <button type="submit" class="btn btn-primary" aria-label="Apply filters">Filter</button>
      <button type="button" id="clearFiltersBtn" class="btn btn-secondary" aria-label="Clear filters">Clear</button>
    </form>

    <!-- Mobile Filter Button (visible sm and below) -->
    <div class="d-flex d-md-none mb-3">
      <button type="button" id="mobileFilterBtn" class="btn btn-primary w-100" aria-haspopup="dialog" aria-controls="mobileFilterPopup" aria-expanded="false">
        <i class="fa fa-filter me-2"></i> Filter Jobs
      </button>
    </div>

    <!-- Mobile Filter Popup -->
    <div id="mobileFilterPopup" role="dialog" aria-modal="true" aria-labelledby="mobileFilterTitle" tabindex="-1">
      <div class="popup-content bg-white p-4 rounded shadow">
        <h5 id="mobileFilterTitle" class="mb-3">Filter Jobs</h5>
        <form id="mobileFilterForm" autocomplete="off" aria-label="Mobile filter jobs form">
          <div class="mb-3">
            <label for="mobileFilterKeyword" class="form-label">Job Title, Skill or Company</label>
            <input type="text" id="mobileFilterKeyword" class="form-control" placeholder="Keyword" />
          </div>
          <div class="mb-3">
            <label for="mobileFilterLocation" class="form-label">Location</label>
            <input type="text" id="mobileFilterLocation" class="form-control" placeholder="Location" />
          </div>
          <div class="mb-3">
            <label for="mobileFilterType" class="form-label">Job Type</label>
            <select id="mobileFilterType" class="form-select">
              <option value="">All Types</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="mobileFilterCategory" class="form-label">Category</label>
            <select id="mobileFilterCategory" class="form-select">
              <option value="">All Categories</option>
            </select>
          </div>
          <div class="d-flex justify-content-between">
            <button type="button" id="mobileClearFiltersBtn" class="btn btn-secondary">Clear Filters</button>
            <div>
              <button type="button" id="mobileFilterCancelBtn" class="btn btn-outline-secondary me-2">Cancel</button>
              <button type="submit" class="btn btn-primary">Apply Filter</button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Job Listings -->
    <div id="jobs-list" class="mt-4">
      <div class="text-center text-muted">Loading jobs...</div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Your Firebase config here â€” REPLACE with your actual config:
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // DOM Elements
    const jobsList = document.getElementById('jobs-list');
    const filterForm = document.getElementById('filter-form');
    const keywordInput = document.getElementById('filter-keyword');
    const locationInput = document.getElementById('filter-location');
    const typeSelect = document.getElementById('filter-type');
    const categorySelect = document.getElementById('filter-category');
    const clearFiltersBtn = document.getElementById('clearFiltersBtn');

    // Mobile popup elements
    const mobileFilterPopup = document.getElementById('mobileFilterPopup');
    const mobileFilterBtn = document.getElementById('mobileFilterBtn');
    const mobileFilterForm = document.getElementById('mobileFilterForm');
    const mobileKeywordInput = document.getElementById('mobileFilterKeyword');
    const mobileLocationInput = document.getElementById('mobileFilterLocation');
    const mobileTypeSelect = document.getElementById('mobileFilterType');
    const mobileCategorySelect = document.getElementById('mobileFilterCategory');
    const mobileFilterCancelBtn = document.getElementById('mobileFilterCancelBtn');
    const mobileClearFiltersBtn = document.getElementById('mobileClearFiltersBtn');

    let allJobs = [];
    let allTypes = new Set();
    let allCategories = new Set();

    // Format date helper
    function formatDate(date) {
      const y = date.getFullYear();
      const m = ('0' + (date.getMonth() + 1)).slice(-2);
      const d = ('0' + date.getDate()).slice(-2);
      return `${y}-${m}-${d}`;
    }

    // Render a single job card
    function renderJob(jobData) {
      const deadlineStr = jobData.deadline ? formatDate(new Date(jobData.deadline)) : 'N/A';
      const daysLeft = jobData.daysLeft > 0 ? `${jobData.daysLeft} days left` : 'Expired';

      const card = document.createElement('div');
      card.className = 'card job-card mb-3';

      card.innerHTML = `
        <div class="card-body">
          <h5 class="card-title">${jobData.title}</h5>
          <h6 class="card-subtitle mb-2 text-muted">${jobData.company}</h6>
          <p class="card-text">
            <strong>Type:</strong> ${jobData.type || 'N/A'}<br />
            <strong>Category:</strong> ${jobData.category || 'N/A'}<br />
            <strong>Deadline:</strong> ${deadlineStr} (${daysLeft})
          </p>
          <a href="${jobData.link}" target="_blank" class="btn btn-primary">Apply / Details</a>
        </div>
      `;
      return card;
    }

    // Populate filter dropdown options dynamically
    function populateFilterOptions() {
      function clearOptions(selectElement) {
        while (selectElement.options.length > 1) {
          selectElement.remove(1);
        }
      }

      clearOptions(typeSelect);
      clearOptions(categorySelect);
      clearOptions(mobileTypeSelect);
      clearOptions(mobileCategorySelect);

      Array.from(allTypes).sort().forEach(type => {
        const opt1 = new Option(type, type);
        typeSelect.add(opt1);
        const opt2 = new Option(type, type);
        mobileTypeSelect.add(opt2);
      });

      Array.from(allCategories).sort().forEach(cat => {
        const opt1 = new Option(cat, cat);
        categorySelect.add(opt1);
        const opt2 = new Option(cat, cat);
        mobileCategorySelect.add(opt2);
      });
    }

    // Filter jobs according to inputs
    function filterJobs() {
      const keyword = keywordInput.value.trim().toLowerCase();
      const location = locationInput.value.trim().toLowerCase();
      const selectedType = typeSelect.value;
      const selectedCategory = categorySelect.value;

      return allJobs.filter(job => {
        if (job.isExpired) return false;

        if (keyword) {
          const combinedText = (job.title + ' ' + job.company).toLowerCase();
          if (!combinedText.includes(keyword)) return false;
        }

        if (location) {
          if (!job.location || !job.location.toLowerCase().includes(location)) return false;
        }

        if (selectedType && job.type !== selectedType) return false;
        if (selectedCategory && job.category !== selectedCategory) return false;

        return true;
      });
    }

    // Render all filtered jobs
    function renderJobs() {
      const filteredJobs = filterJobs();

      jobsList.innerHTML = '';
      if (filteredJobs.length === 0) {
        jobsList.innerHTML = '<p class="text-center text-muted">No jobs found matching your criteria.</p>';
        return;
      }

      filteredJobs.forEach(job => {
        const card = renderJob(job);
        jobsList.appendChild(card);
      });
    }

    // Clear all filters
    function clearFilters() {
      keywordInput.value = '';
      locationInput.value = '';
      typeSelect.value = '';
      categorySelect.value = '';

      mobileKeywordInput.value = '';
      mobileLocationInput.value = '';
      mobileTypeSelect.value = '';
      mobileCategorySelect.value = '';

      renderJobs();
    }

    // Sync mobile filters with desktop filters (and vice versa)
    function syncFiltersToMobile() {
      mobileKeywordInput.value = keywordInput.value;
      mobileLocationInput.value = locationInput.value;
      mobileTypeSelect.value = typeSelect.value;
      mobileCategorySelect.value = categorySelect.value;
    }
    function syncFiltersToDesktop() {
      keywordInput.value = mobileKeywordInput.value;
      locationInput.value = mobileLocationInput.value;
      typeSelect.value = mobileTypeSelect.value;
      categorySelect.value = mobileCategorySelect.value;
    }

    // Load jobs from Firestore
    async function loadJobs() {
      try {
        const snapshot = await db.collection('jobs').get();

        allJobs = snapshot.docs.map(doc => {
          const data = doc.data();

          let deadlineDate = null;
          if (data.deadline) {
            deadlineDate = new Date(data.deadline);
          }

          const today = new Date();
          today.setHours(0,0,0,0);

          let isExpired = false;
          let daysLeft = null;
          if (deadlineDate) {
            isExpired = deadlineDate < today;
            daysLeft = Math.ceil((deadlineDate - today) / (1000 * 60 * 60 * 24));
          }

          if (data.type) allTypes.add(data.type);
          if (data.category) allCategories.add(data.category);

          return {
            id: doc.id,
            title: data.title || '',
            company: data.company || '',
            type: data.type || '',
            category: data.category || '',
            deadline: data.deadline || '',
            link: data.link || '#',
            location: data.location || '',
            isExpired,
            daysLeft
          };
        });

        // Sort by nearest deadline first (null deadlines last)
        allJobs.sort((a,b) => {
          if (!a.deadline) return 1;
          if (!b.deadline) return -1;
          return new Date(a.deadline) - new Date(b.deadline);
        });

        populateFilterOptions();

        renderJobs();
      } catch (error) {
        jobsList.innerHTML = '<p class="text-danger text-center">Error loading jobs. Please try again later.</p>';
        console.error('Error loading jobs:', error);
      }
    }

    // Event Listeners

    // Desktop filter form submit
    filterForm.addEventListener('submit', e => {
      e.preventDefault();
      renderJobs();
      syncFiltersToMobile();
    });

    // Clear desktop filters
    clearFiltersBtn.addEventListener('click', e => {
      e.preventDefault();
      clearFilters();
      syncFiltersToMobile();
    });

    // Show mobile filter popup
    mobileFilterBtn.addEventListener('click', () => {
      syncFiltersToMobile();
      mobileFilterPopup.style.display = 'flex';
      mobileFilterPopup.setAttribute('aria-hidden', 'false');
      mobileFilterBtn.setAttribute('aria-expanded', 'true');
      mobileKeywordInput.focus();
    });

    // Hide mobile filter popup (cancel)
    mobileFilterCancelBtn.addEventListener('click', () => {
      mobileFilterPopup.style.display = 'none';
      mobileFilterPopup.setAttribute('aria-hidden', 'true');
      mobileFilterBtn.setAttribute('aria-expanded', 'false');
    });

    // Mobile filter form submit
    mobileFilterForm.addEventListener('submit', e => {
      e.preventDefault();
      syncFiltersToDesktop();
      renderJobs();
      mobileFilterPopup.style.display = 'none';
      mobileFilterPopup.setAttribute('aria-hidden', 'true');
      mobileFilterBtn.setAttribute('aria-expanded', 'false');
    });

    // Clear mobile filters
    mobileClearFiltersBtn.addEventListener('click', () => {
      mobileKeywordInput.value = '';
      mobileLocationInput.value = '';
      mobileTypeSelect.value = '';
      mobileCategorySelect.value = '';

      clearFilters();

      mobileFilterPopup.style.display = 'none';
      mobileFilterPopup.setAttribute('aria-hidden', 'true');
      mobileFilterBtn.setAttribute('aria-expanded', 'false');
    });

    // Close mobile popup if user clicks outside the popup content
    mobileFilterPopup.addEventListener('click', e => {
      if (e.target === mobileFilterPopup) {
        mobileFilterPopup.style.display = 'none';
        mobileFilterPopup.setAttribute('aria-hidden', 'true');
        mobileFilterBtn.setAttribute('aria-expanded', 'false');
      }
    });

    // Load jobs on page load
    window.addEventListener('load', loadJobs);
  </script>
</body>
</html>
