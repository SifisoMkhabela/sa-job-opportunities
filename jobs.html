<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SA Job Opportunities - Jobs</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <!-- Custom CSS -->
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- Header -->
  <header class="top-bar bg-light py-3 border-bottom">
    <div class="container d-flex align-items-center">
      <a href="index.html" class="d-flex align-items-center text-decoration-none">
        <img src="logo.png" alt="SA Job Opportunities" class="logo" style="height:50px; width:auto; object-fit:contain; flex-shrink: 0;" />
        <h1 class="ms-3 mb-0 text-dark" style="font-size:0.75rem; font-weight:300; letter-spacing:0.03em; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
          SA Job Opportunities
        </h1>
      </a>
    </div>
  </header>

  <main class="container my-5">
    <h1 class="mb-4">Job Listings</h1>

    <!-- Mobile Filter Button -->
    <div class="d-md-none mb-3 text-end">
      <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#filterModal">
        <i class="fas fa-filter"></i> Filter Jobs
      </button>
    </div>

    <!-- Filter Form for Desktop -->
    <form id="filter-form" class="row g-3 mb-4 d-none d-md-flex">
      <div class="col-md-4">
        <input type="text" id="filter-keyword" class="form-control" placeholder="Job Title, Skill or Company" autocomplete="off" />
      </div>
      <div class="col-md-3">
        <input type="text" id="filter-location" class="form-control" placeholder="Location" autocomplete="off" />
      </div>
      <div class="col-md-3">
        <select id="filter-category" class="form-select">
          <option value="">All Categories</option>
          <option value="IT">IT</option>
          <option value="Finance">Finance</option>
          <option value="Sales">Sales</option>
          <option value="Engineering">Engineering</option>
          <option value="Manufacturing">Manufacturing</option>
          <option value="General">General</option>
          <option value="Accounting">Accounting</option>
          <option value="Insurance">Insurance</option>
          <option value="Admin">Admin</option>
        </select>
      </div>
      <div class="col-md-2">
        <button type="submit" class="btn btn-primary w-100">Filter</button>
      </div>
    </form>

    <!-- Filter Modal for Mobile -->
    <div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="filter-form-mobile">
            <div class="modal-header">
              <h5 class="modal-title" id="filterModalLabel">Filter Jobs</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <input type="text" id="filter-keyword-mobile" class="form-control" placeholder="Job Title, Skill or Company" autocomplete="off" />
              </div>
              <div class="mb-3">
                <input type="text" id="filter-location-mobile" class="form-control" placeholder="Location" autocomplete="off" />
              </div>
              <div class="mb-3">
                <select id="filter-category-mobile" class="form-select">
                  <option value="">All Categories</option>
                  <option value="IT">IT</option>
                  <option value="Finance">Finance</option>
                  <option value="Sales">Sales</option>
                  <option value="Engineering">Engineering</option>
                  <option value="Manufacturing">Manufacturing</option>
                  <option value="General">General</option>
                  <option value="Accounting">Accounting</option>
                  <option value="Insurance">Insurance</option>
                  <option value="Admin">Admin</option>
                </select>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" onclick="clearFilters()">Clear Filters</button>
              <button type="submit" class="btn btn-primary" data-bs-dismiss="modal">Apply Filter</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div id="jobs-list" class="list-group">
      <div class="text-center text-muted">Loading jobs...</div>
    </div>
  </main>

  <footer class="bg-dark text-white py-4 mt-5">
    <div class="container text-center">&copy; 2025 SA Job Opportunities. All rights reserved.</div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/firebase-config.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const jobsList = document.getElementById('jobs-list');
      const filterForm = document.getElementById('filter-form');
      const filterFormMobile = document.getElementById('filter-form-mobile');

      let allJobs = [];

      function getFilterValues(isMobile = false) {
        return {
          keyword: (document.getElementById(isMobile ? 'filter-keyword-mobile' : 'filter-keyword').value || '').trim().toLowerCase(),
          location: (document.getElementById(isMobile ? 'filter-location-mobile' : 'filter-location').value || '').trim().toLowerCase(),
          category: document.getElementById(isMobile ? 'filter-category-mobile' : 'filter-category').value || ''
        };
      }

      function renderJob(jobData) {
        const card = document.createElement('div');
        card.className = 'list-group-item list-group-item-action flex-column align-items-start mb-3';
        card.innerHTML = `
          <div class="d-flex w-100 justify-content-between">
            <h5 class="mb-1">${jobData.title}</h5>
            <small>${jobData.postedDate || ''}</small>
          </div>
          <p class="mb-1">${jobData.company} â€” ${jobData.location}</p>
          <small>Job Type: ${jobData.type} | ${jobData.daysLeft ? jobData.daysLeft + ' days left' : ''}</small>
          <div class="mt-2">
            <a href="${jobData.link || '#'}" target="_blank" class="btn btn-sm btn-primary">Apply Now</a>
          </div>
        `;
        return card;
      }

      function displayJobs(jobs) {
        jobsList.innerHTML = '';
        if (jobs.length === 0) {
          jobsList.innerHTML = '<div class="text-center text-muted">No jobs found.</div>';
          return;
        }
        jobs.forEach(job => jobsList.appendChild(renderJob(job)));
      }

      function filterJobs(isMobile = false) {
        const { keyword, location, category } = getFilterValues(isMobile);
        const filtered = allJobs.filter(job => {
          const matchesKeyword = keyword === '' || job.title.toLowerCase().includes(keyword) || job.company.toLowerCase().includes(keyword);
          const matchesLocation = location === '' || (job.location && job.location.toLowerCase().includes(location));
          const matchesCategory = category === '' || (job.category && job.category === category);
          return matchesKeyword && matchesLocation && matchesCategory;
        });
        displayJobs(filtered);
      }

      function clearFilters() {
        ['filter-keyword', 'filter-location', 'filter-keyword-mobile', 'filter-location-mobile'].forEach(id => document.getElementById(id).value = '');
        ['filter-category', 'filter-category-mobile'].forEach(id => document.getElementById(id).selectedIndex = 0);
        displayJobs(allJobs);
      }

      function loadJobs() {
        const db = firebase.firestore();
        db.collection('jobs').get().then(snapshot => {
          allJobs = [];
          snapshot.forEach(doc => {
            const job = doc.data();
            const deadline = job.deadline ? new Date(job.deadline) : null;
            let daysLeft = '';
            if (deadline) {
              const now = new Date();
              const diffTime = deadline - now;
              daysLeft = diffTime > 0 ? Math.ceil(diffTime / (1000 * 60 * 60 * 24)) : 0;
            }
            allJobs.push({
              title: job.title || 'No title',
              company: job.company || 'No company',
              location: job.location || 'No location',
              type: job.type || 'N/A',
              postedDate: job.postedDate || '',
              daysLeft: daysLeft,
              link: job.link || '#',
              category: job.category || ''
            });
          });
          displayJobs(allJobs);
        }).catch(error => {
          console.error('Error fetching jobs:', error);
          jobsList.innerHTML = '<div class="text-center text-danger">Failed to load jobs. Please try again later.</div>';
        });
      }

      filterForm.addEventListener('submit', e => {
        e.preventDefault();
        filterJobs(false);
      });

      filterFormMobile.addEventListener('submit', e => {
        e.preventDefault();
        filterJobs(true);
      });

      loadJobs();
    });
  </script>
</body>
</html>
