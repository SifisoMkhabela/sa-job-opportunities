<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SA Job Opportunities - Jobs</title>

  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <!-- Font Awesome -->
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    rel="stylesheet"
  />
  <!-- Custom CSS -->
  <style>
    /* Popup styles */
    #mobileFilterPopup {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none; /* hidden by default */
      z-index: 1050;
      justify-content: center;
      align-items: center;
      padding: 1rem;
    }
    #mobileFilterPopup .popup-content {
      background: white;
      border-radius: 8px;
      max-width: 400px;
      width: 100%;
      padding: 20px;
    }

    /* Hide desktop filters on small screens */
    @media (max-width: 767px) {
      #desktopFilters {
        display: none;
      }
      #mobileFilterBtn {
        display: block;
      }
    }
    /* Hide mobile filter button on larger screens */
    @media (min-width: 768px) {
      #mobileFilterBtn {
        display: none;
      }
    }

    /* Job card styling */
    .job-card {
      margin-bottom: 1rem;
    }

  </style>
</head>
<body>
  <!-- Header -->
  <header class="top-bar bg-light py-3 border-bottom">
    <div class="container d-flex align-items-center">
      <a href="index.html" class="d-flex align-items-center text-decoration-none">
        <img src="logo.png" alt="SA Job Opportunities" class="logo" style="height:50px; width:auto; object-fit:contain; flex-shrink: 0;" />
        <h1 class="ms-3 mb-0 text-dark" style="font-size:0.75rem; font-weight:300; letter-spacing:0.03em; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
          SA Job Opportunities
        </h1>
      </a>
    </div>
  </header>

  <main class="container my-5">
    <h1 class="mb-4">Job Listings</h1>

    <!-- Desktop Filters -->
    <form id="filter-form" class="row g-3 mb-4" autocomplete="off">
      <div id="desktopFilters" class="d-flex flex-wrap gap-3 align-items-center">
        <input
          type="text"
          id="filter-keyword"
          class="form-control"
          placeholder="Job Title, Skill or Company"
          style="min-width: 200px;"
        />
        <input
          type="text"
          id="filter-location"
          class="form-control"
          placeholder="Location"
          style="min-width: 150px;"
        />
        <select id="filter-type" class="form-select" style="min-width: 150px;">
          <option value="">All Types</option>
          <!-- Dynamic -->
        </select>
        <select id="filter-category" class="form-select" style="min-width: 150px;">
          <option value="">All Categories</option>
          <!-- Dynamic -->
        </select>
        <button type="submit" class="btn btn-primary">Filter</button>
        <button type="button" id="clearFiltersBtn" class="btn btn-secondary">Clear Filters</button>
      </div>

      <!-- Mobile Filter Button -->
      <div class="d-flex d-md-none mt-3">
        <button type="button" id="mobileFilterBtn" class="btn btn-primary w-100">
          <i class="fa fa-filter me-2"></i> Filter Jobs
        </button>
      </div>
    </form>

    <!-- Mobile Filter Popup -->
    <div id="mobileFilterPopup" aria-hidden="true" role="dialog" aria-modal="true">
      <div class="popup-content">
        <h5>Filter Jobs</h5>
        <form id="mobileFilterForm" autocomplete="off">
          <div class="mb-3">
            <label for="mobileFilterKeyword" class="form-label">Job Title, Skill or Company</label>
            <input type="text" id="mobileFilterKeyword" class="form-control" placeholder="Keyword" />
          </div>
          <div class="mb-3">
            <label for="mobileFilterLocation" class="form-label">Location</label>
            <input type="text" id="mobileFilterLocation" class="form-control" placeholder="Location" />
          </div>
          <div class="mb-3">
            <label for="mobileFilterType" class="form-label">Job Type</label>
            <select id="mobileFilterType" class="form-select">
              <option value="">All Types</option>
              <!-- Dynamic -->
            </select>
          </div>
          <div class="mb-3">
            <label for="mobileFilterCategory" class="form-label">Category</label>
            <select id="mobileFilterCategory" class="form-select">
              <option value="">All Categories</option>
              <!-- Dynamic -->
            </select>
          </div>
          <div class="d-flex justify-content-between">
            <button type="button" id="mobileClearFiltersBtn" class="btn btn-secondary">Clear Filters</button>
            <div>
              <button type="button" id="mobileFilterCancelBtn" class="btn btn-outline-secondary me-2">Cancel</button>
              <button type="submit" class="btn btn-primary">Apply Filter</button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Job Listings -->
    <div id="jobs-list" class="mt-4">
      <div class="text-center text-muted">Loading jobs...</div>
    </div>
  </main>

  <footer class="bg-dark text-white py-4 mt-5 text-center">
    &copy; 2025 SA Job Opportunities. All rights reserved.
  </footer>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // Your Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDTfLfb9gnn4zBGju8XoqAe-i7g9ahJyJk",
      authDomain: "sa-job-opportunities.firebaseapp.com",
      projectId: "sa-job-opportunities",
      storageBucket: "sa-job-opportunities.appspot.com",
      messagingSenderId: "370537417491",
      appId: "1:370537417491:web:520e9dc1efb1d8cf38a8e6",
      measurementId: "G-ZTK2KXSLXD"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // DOM Elements
    const jobsList = document.getElementById('jobs-list');
    const filterForm = document.getElementById('filter-form');
    const keywordInput = document.getElementById('filter-keyword');
    const locationInput = document.getElementById('filter-location');
    const typeSelect = document.getElementById('filter-type');
    const categorySelect = document.getElementById('filter-category');
    const clearFiltersBtn = document.getElementById('clearFiltersBtn');

    // Mobile popup elements
    const mobileFilterPopup = document.getElementById('mobileFilterPopup');
    const mobileFilterBtn = document.getElementById('mobileFilterBtn');
    const mobileFilterForm = document.getElementById('mobileFilterForm');
    const mobileKeywordInput = document.getElementById('mobileFilterKeyword');
    const mobileLocationInput = document.getElementById('mobileFilterLocation');
    const mobileTypeSelect = document.getElementById('mobileFilterType');
    const mobileCategorySelect = document.getElementById('mobileFilterCategory');
    const mobileFilterCancelBtn = document.getElementById('mobileFilterCancelBtn');
    const mobileClearFiltersBtn = document.getElementById('mobileClearFiltersBtn');

    let allJobs = [];
    let allTypes = new Set();
    let allCategories = new Set();

    // Utility: format date as yyyy-mm-dd
    function formatDate(date) {
      const y = date.getFullYear();
      const m = ('0' + (date.getMonth() + 1)).slice(-2);
      const d = ('0' + date.getDate()).slice(-2);
      return `${y}-${m}-${d}`;
    }

    // Render a single job card
    function renderJob(jobData) {
      const deadlineStr = jobData.deadline ? formatDate(new Date(jobData.deadline)) : 'N/A';
      const daysLeft = jobData.daysLeft > 0 ? `${jobData.daysLeft} days left` : 'Expired';

      const card = document.createElement('div');
      card.className = 'card job-card';

      card.innerHTML = `
        <div class="card-body">
          <h5 class="card-title">${jobData.title}</h5>
          <h6 class="card-subtitle mb-2 text-muted">${jobData.company}</h6>
          <p class="card-text">
            <strong>Type:</strong> ${jobData.type || 'N/A'}<br />
            <strong>Category:</strong> ${jobData.category || 'N/A'}<br />
            <strong>Deadline:</strong> ${deadlineStr} (${daysLeft})
          </p>
          <a href="${jobData.link}" target="_blank" class="btn btn-primary">Apply / Details</a>
        </div>
      `;
      return card;
    }

    // Populate filter dropdown options dynamically
    function populateFilterOptions() {
      // Clear existing options except first "All"
      function clearOptions(selectElement) {
        while (selectElement.options.length > 1) {
          selectElement.remove(1);
        }
      }

      clearOptions(typeSelect);
      clearOptions(categorySelect);
      clearOptions(mobileTypeSelect);
      clearOptions(mobileCategorySelect);

      // Add dynamic options sorted alphabetically
      Array.from(allTypes).sort().forEach(type => {
        const opt1 = new Option(type, type);
        typeSelect.add(opt1);
        const opt2 = new Option(type, type);
        mobileTypeSelect.add(opt2);
      });

      Array.from(allCategories).sort().forEach(cat => {
        const opt1 = new Option(cat, cat);
        categorySelect.add(opt1);
        const opt2 = new Option(cat, cat);
        mobileCategorySelect.add(opt2);
      });
    }

    // Filter jobs according to inputs
    function filterJobs() {
      const keyword = keywordInput.value.trim().toLowerCase();
      const location = locationInput.value.trim().toLowerCase();
      const selectedType = typeSelect.value;
      const selectedCategory = categorySelect.value;

      return allJobs.filter(job => {
        // Check expired
        if (job.isExpired) return false;

        // Keyword matches title, company or location (if provided)
        if (keyword) {
          const combinedText = (job.title + ' ' + job.company).toLowerCase();
          if (!combinedText.includes(keyword)) return false;
        }

        // Location filtering (optional)
        if (location) {
          // If job.location exists, filter by location
          if (!job.location || !job.location.toLowerCase().includes(location)) return false;
        }

        if (selectedType && job.type !== selectedType) return false;
        if (selectedCategory && job.category !== selectedCategory) return false;

        return true;
      });
    }

    // Render all filtered jobs
    function renderJobs() {
      const filteredJobs = filterJobs();

      jobsList.innerHTML = '';
      if (filteredJobs.length === 0) {
        jobsList.innerHTML = '<p class="text-center text-muted">No jobs found matching your criteria.</p>';
        return;
      }

      filteredJobs.forEach(job => {
        const card = renderJob(job);
        jobsList.appendChild(card);
      });
    }

    // Clear all filters
    function clearFilters() {
      keywordInput.value = '';
      locationInput.value = '';
      typeSelect.value = '';
      categorySelect.value = '';

      mobileKeywordInput.value = '';
      mobileLocationInput.value = '';
      mobileTypeSelect.value = '';
      mobileCategorySelect.value = '';

      renderJobs();
    }

    // Sync mobile filters with desktop filters (and vice versa)
    function syncFiltersToMobile() {
      mobileKeywordInput.value = keywordInput.value;
      mobileLocationInput.value = locationInput.value;
      mobileTypeSelect.value = typeSelect.value;
      mobileCategorySelect.value = categorySelect.value;
    }
    function syncFiltersToDesktop() {
      keywordInput.value = mobileKeywordInput.value;
      locationInput.value = mobileLocationInput.value;
      typeSelect.value = mobileTypeSelect.value;
      categorySelect.value = mobileCategorySelect.value;
    }

    // Load jobs from Firestore
    async function loadJobs() {
      try {
        const snapshot = await db.collection('jobs').get();

        allJobs = snapshot.docs.map(doc => {
          const data = doc.data();

          // Parse deadline date if exists
          let deadlineDate = null;
          if (data.deadline) {
            // Firestore stores timestamps, but you said string format "yyyy-mm-dd" — parse it:
            deadlineDate = new Date(data.deadline);
          }

          const today = new Date();
          today.setHours(0,0,0,0); // reset to start of day

          // Determine if job is expired
          let isExpired = false;
          let daysLeft = null;
          if (deadlineDate) {
            isExpired = deadlineDate < today;
            daysLeft = Math.ceil((deadlineDate - today) / (1000 * 60 * 60 * 24));
          }

          // Collect unique types and categories
          if (data.type) allTypes.add(data.type);
          if (data.category) allCategories.add(data.category);

          return {
            id: doc.id,
            title: data.title || '',
            company: data.company || '',
            type: data.type || '',
            category: data.category || '',
            deadline: data.deadline || '',
            link: data.link || '#',
            location: data.location || '', // optional, if you add it
            isExpired,
            daysLeft
          };
        });

        // Sort jobs by deadline ascending (soonest deadline first)
        allJobs.sort((a,b) => {
          if (!a.deadline) return 1;
          if (!b.deadline) return -1;
          return new Date(a.deadline) - new Date(b.deadline);
        });

        // Populate filter dropdowns dynamically
        populateFilterOptions();

        renderJobs();
      } catch (error) {
        jobsList.innerHTML = '<p class="text-danger text-center">Error loading jobs. Please try again later.</p>';
        console.error('Error loading jobs:', error);
      }
    }

    // Event Listeners

    // Desktop filter form submit
    filterForm.addEventListener('submit', e => {
      e.preventDefault();
      renderJobs();
      // Sync mobile filters so popup stays up to date if opened later
      syncFiltersToMobile();
    });

    // Clear desktop filters
    clearFiltersBtn.addEventListener('click', e => {
      e.preventDefault();
      clearFilters();
      syncFiltersToMobile();
    });

    // Mobile Filter popup show/hide
    mobileFilterBtn.addEventListener('click', () => {
      syncFiltersToMobile();
      mobileFilterPopup.style.display = 'flex';
      mobileFilterPopup.setAttribute('aria-hidden', 'false');
    });

    mobileFilterCancelBtn.addEventListener('click', () => {
      mobileFilterPopup.style.display = 'none';
      mobileFilterPopup.setAttribute('aria-hidden', 'true');
    });

    // Mobile Filter form submit
    mobileFilterForm.addEventListener('submit', e => {
      e.preventDefault();
      // Sync mobile filters values back to desktop
      syncFiltersToDesktop();
      renderJobs();
      mobileFilterPopup.style.display = 'none';
      mobileFilterPopup.setAttribute('aria-hidden', 'true');
    });

    // Clear mobile filters
    mobileClearFiltersBtn.addEventListener('click', () => {
      mobileKeywordInput.value = '';
      mobileLocationInput.value = '';
      mobileTypeSelect.value = '';
      mobileCategorySelect.value = '';

      // Also clear desktop filters to keep in sync
      clearFilters();

      mobileFilterPopup.style.display = 'none';
      mobileFilterPopup.setAttribute('aria-hidden', 'true');
    });

    // Initial load
    loadJobs();
  </script>
</body>
</html>
